name: "[Tests] Monitoring Lambda Unit Tests"

defaults:
  run:
    shell: bash

on:
  workflow_call:

jobs:
  monitoring-lambda-unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@96f53100ba2a5449eb71d2e6604bbcd94b9449b5 # pin@v3
      - name: run monitoring lambda unit tests
        id: unit-tests
        run: |
          docker-compose up -d
          sleep 5
          docker-compose run pythontests python -m pytest
          docker-compose down
        working-directory: lambdas
      - name: archive monitoring lambda
        run: |
          export LAYER_PATH=lambdas/layers/monitoring/python/lib/python3.7/site-packages
          python3 -m pip install -r lambdas/requirements/requirements.txt --target ./$LAYER_PATH/
          cd lambdas
          tar cvf layer.tar layers
      - name: archive lambda layer tar
        uses: actions/upload-artifact@65d862660abb392b8c4a3d1195a2108db131dd05 # pin@v3.1.0
        with:
          name: layer.tar
          path: lambdas/
