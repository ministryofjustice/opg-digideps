name: "[Docker] Build web resources"

defaults:
  run:
    shell: bash

on:
  workflow_call:

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@7cdaf2fbc075e6f3b9ca94cfd6cec5adc8a75622 # pin@v3
      - name: create nvmrc file
        run: grep "FROM node:" Dockerfile | awk -F' ' '{print $2}' | sed 's/^node:\(.*\)-.*/\1/' > .nvmrc
        working-directory: client/docker/resources
      - uses: actions/setup-node@2a017f350dbf6c4b6bb4508cc83809719115162e # pin@v3.6.0
        with:
          node-version-file: "client/docker/resources/.nvmrc"
      - name: cache node modules
        id: cache-npm
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # pin@v3.0.8
        env:
          cache-name: cache-node-modules
        with:
          path: client/resources/public
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json', ) }}
      - name: Check if directory exists and has content
        id: check-directory
        run: |
          directory="client/resources/public/assets"
          if [ -d "$directory" ] && [ "$(ls -A "$directory")" ]; then
            echo "directory_exists=$(echo true)" >> $GITHUB_OUTPUT
          else
            echo "directory_exists=$(echo false)" >> $GITHUB_OUTPUT
          fi
      - name: Build assets
        if: steps.check-directory.outputs.directory_exists == 'false'
        run: |
          # Install NPM dependencies
          npm install
          npm run lint
          npm audit --production
          #Build assets
          NODE_ENV=production npm run build
        working-directory: client/resources
      - name: archive dist
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # pin@v3.1.0
        with:
          name: web-distribution
          path: client/resources/public
