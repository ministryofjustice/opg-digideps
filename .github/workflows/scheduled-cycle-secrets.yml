name: "[Scheduled] Cycle Secrets"

on:
  schedule:
    # 3AM from Sunday to Friday
    - cron: "0 3 * * 0-5"

#on:
#  push:
#    branches:
#      - "*" # matches every branch that doesn't contain a '/'
#      - "*/*" # matches every branch containing a single '/'
#      - "**" # matches every branch
#      - "!main" # reverse match main
#      - "!dependabot/**" # reverse match dependabot PRs
#      - "dependabot/docker/**" # match dependabot PRs that update docker

permissions:
  contents: read
  security-events: none
  pull-requests: none
  actions: none
  checks: none
  deployments: none
  issues: none
  packages: none
  repository-projects: none
  statuses: none

jobs:
  rotate_secrets:
    name: rotate secrets
    uses: ./.github/workflows/_cycle_secrets.yml
    with:
      account: 248804316466
      workspace: development
    secrets: inherit

  latest_deployed_image:
    name: development environment apply terraform
    uses: ./.github/workflows/_latest_deployed_image.yml
    with:
      workspace: training
      terraform_path: environment
    secrets: inherit

  terraform_apply_development:
    name: development environment apply terraform
    uses: ./.github/workflows/_run-terraform.yml
    needs:
      - cycle_secrets_for_env
      - latest_deployed_image
    with:
      workspace: ddpb4597
      terraform_path: environment
      apply: true
      container_version: ${{ needs.latest_deployed_image.outputs.image_tag }}
    secrets: inherit
