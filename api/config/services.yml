imports:
    - { resource: packages/doctrine_migrations.yml }
    - { resource: packages/doctrine.yml }
    - { resource: packages/framework.yml }
    - { resource: packages/monolog.yml }
    - { resource: packages/sensio_framework_extra.yml }
    - { resource: packages/snc_redis.yml }
    - { resource: services/assemblers.yml }
    - { resource: services/factories.yml }

parameters:
    fixtures:
        account_password: '%env(FIXTURES_ACCOUNTPASSWORD)%'

services:
    em:
        alias: doctrine.orm.entity_manager

    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
        bind:
            $fixturesEnabled: "%env(bool:FIXTURES_ENABLED)%"
            $yamlFixtureLocation: "%kernel.root_dir%/src/DataFixtures/"
            $fixtureParams: '%fixtures%'
            $symfonyEnvironment: "%kernel.environment%"
            $rootDir: "%kernel.root_dir%"

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/*'
        exclude: '../src/{DependencyInjection,Entity,Migrations,Tests,Kernel.php}'

    App\Controller\:
        resource: '../src/Controller/'
        tags: [controller.service_arguments]

    Doctrine\Migrations\Version\DbalMigrationFactory: ~
    App\Migrations\Factory\MigrationFactoryDecorator:
        decorates: Doctrine\Migrations\Version\DbalMigrationFactory
        arguments: ['@App\Migrations\Factory\MigrationFactoryDecorator.inner', '@service_container']


    monolog.processor.add_request_id:
        class: App\Service\RequestIdLoggerProcessor
        arguments:  [ "@service_container" ]
        tags:
            - { name: monolog.processor, method: processRecord }

    gedmo.listener.softdeleteable:
        class: Gedmo\SoftDeleteable\SoftDeleteableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    gedmo.listener.timestampable:
        class: Gedmo\Timestampable\TimestampableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    App\DataFixtures\:
        resource: '../src/DataFixtures'
        tags: ['doctrine.fixture.orm']
        autowire: true

    App\Controller\Report\ReportController:
        class: App\Controller\Report\ReportController
        arguments:
            $updateHandlers: [
                '@rest_handler.report.deputy_costs_estimate_report_update_handler',
                '@rest_handler.report.deputy_costs_report_update_handler',
                '@rest_handler.report.pa_fees_expenses_report_update_handler'
            ]

    App\EventListener\RestInputOuputFormatter:
        arguments: [ "@jms_serializer", "@logger", ["json"], "json", "%kernel.debug%" ]
        tags:
            - { name: kernel.event_listener, event: kernel.view, method: onKernelView }
            - { name: kernel.event_listener, event: kernel.exception, method: onKernelException }
            - { name: kernel.event_listener, event: kernel.request, method: onKernelRequest }

    App\EventListener\DoctrineListener:
        tags:
            - { name: doctrine.event_listener, event: prePersist, method: prePersist }
            - { name: doctrine.event_listener, event: preUpdate, method: preUpdate }
            - { name: doctrine.event_listener, event: preRemove, method: preRemove }

    App\EventListener\FixDefaultSchemaListener:
        class: App\EventListener\FixDefaultSchemaListener
        tags:
            - { name: doctrine.event_listener, event: postGenerateSchema, method: postGenerateSchema }

    App\Factory\OrganisationFactory:
        class: App\Factory\OrganisationFactory
        arguments: ['%shared_email_domains%']

    App\Service\RestHandler\OrganisationRestHandler:
        class: App\Service\RestHandler\OrganisationRestHandler
        arguments:
            - '@em'
            - '@validator'
            - '@App\Repository\OrganisationRepository'
            - '@App\Repository\UserRepository'
            - '@App\Factory\OrganisationFactory'
            - '%shared_email_domains%'

    App\Service\Auth\UserProvider:
        arguments: [ '@em', "@snc_redis.default", "@logger", { "timeout_seconds": "%user_provider_timeout_seconds%" }, '@App\Repository\UserRepository' ]

    App\Security\OrganisationVoter:
        class: App\Security\OrganisationVoter
        arguments: [ "@security.helper" ]
        tags:
            - { name: security.voter }

    App\Security\ClientVoter:
        class: App\Security\ClientVoter
        arguments: [ "@security.helper" ]
        tags:
            - { name: security.voter }

    App\Security\UserVoter:
        class: App\Security\UserVoter
        tags:
            - { name: security.voter }

    #Â Disable autowiring for these helper classes
    App\Service\ReportStatusService: ~
    App\Service\Stats\StatsQueryParameters: ~

    Symfony\Component\Security\Core\Role\RoleHierarchyInterface: '@security.role_hierarchy'

    App\Repository\UserRepository:
        class: App\Entity\User
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\User

    App\Repository\ReportRepository:
        class: App\Entity\Report\Report
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\Report\Report

    App\Repository\ClientRepository:
        class: App\Entity\Client
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\Client

    App\Repository\OrganisationRepository:
        class: App\Entity\Organisation
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\Organisation

    App\Repository\NamedDeputyRepository:
        class: App\Entity\NamedDeputy
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\NamedDeputy

    App\Repository\CasRecRepository:
        class: App\Entity\CasRec
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\CasRec

    App\Repository\NdrRepository:
        class: App\Entity\Ndr\Ndr
        factory: ["@doctrine.orm.entity_manager", getRepository]
        arguments:
            - App\Entity\Ndr\Ndr

    rest_handler.report.deputy_costs_estimate_report_update_handler:
        class: App\Service\RestHandler\Report\DeputyCostsEstimateReportUpdateHandler
        arguments: [ '@em' ]

    rest_handler.report.deputy_costs_report_update_handler:
        class: App\Service\RestHandler\Report\DeputyCostsReportUpdateHandler
        arguments: [ '@em' ]

    rest_handler.report.pa_fees_expenses_report_update_handler:
        class: App\Service\RestHandler\Report\PaFeesExpensesReportUpdateHandler
        arguments: [ '@em' ]