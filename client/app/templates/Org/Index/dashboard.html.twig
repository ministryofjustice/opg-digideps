{% extends '@App/Layouts/application.html.twig' %}

{% set translationDomain = "org-dashboard" %}
{% trans_default_domain translationDomain %}
{% set navSection = "org-dashboard" %}

{% block htmlTitle %}{{ 'htmlTitle' | trans }}{% endblock %}
{% block pageTitle %}{{ 'pageTitle' | trans }}{% endblock %}


{% block pageContent %}

    <details class="govuk-details" data-module="govuk-details">
        <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text">{{ 'overdueHelpTextHeader' | trans }}</span>
        </summary>
        <div class="govuk-details__text">
            <p class="govuk-body">{{ 'overdueHelpTextParagraph1' | trans }}</p>
            <p class="govuk-body">{{ 'overdueHelpTextParagraph2' | trans }}</p>
        </div>
    </details>

    <form action="{{ path('org_dashboard') }}" method="GET">
        <div class="govuk-form-group">
            <h2 class="govuk-label-wrapper">
                <label for="search" class="govuk-label govuk-label--s">{{ 'searchBy' | trans }}</label>
            </h2>
            <input type="text" id="search" name="q" value="{{ filters.q }}" class="govuk-input">
        </div>

        <div class="govuk-form-group">
            <fieldset class="govuk-fieldset">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend govuk-fieldset__legend--s">
                    <h2 class="govuk-fieldset__heading">
                        {{ 'filterBy' | trans }}
                    </h2>
                </legend>
                <div class="govuk-radios govuk-radios--small" data-module="govuk-radios">
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="status-1" name="status" type="radio" value=""{{ filters.status == '' ? ' checked="checked"' : '' }}>
                        <label class="govuk-label govuk-radios__label" for="status-1">
                            {{ 'tabClients' | trans }} ({{ counts.total }})
                        </label>
                    </div>
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="status-2" name="status" type="radio" value="notStarted"{{ filters.status == 'notStarted' ? ' checked="checked"' : '' }}>
                        <label class="govuk-label govuk-radios__label" for="status-2">
                            {{ 'notStarted' | trans({}, 'common') }} ({{ counts.notStarted }})
                        </label>
                    </div>
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="status-3" name="status" type="radio" value="notFinished"{{ filters.status == 'notFinished' ? ' checked="checked"' : '' }}>
                        <label class="govuk-label govuk-radios__label" for="status-3">
                            {{ 'inProgress' | trans({}, 'common') }} ({{ counts.notFinished }})
                        </label>
                    </div>
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="status-4" name="status" type="radio" value="readyToSubmit"{{ filters.status == 'readyToSubmit' ? ' checked="checked"' : '' }}>
                        <label class="govuk-label govuk-radios__label" for="status-4">
                            {{ 'readyToSubmit' | trans({}, 'common') }} ({{ counts.readyToSubmit }})
                        </label>
                    </div>
                </div>
            </fieldset>
        </div>

        <div class="govuk-form-group">
            <input id="search_submit" class="govuk-button govuk-!-margin-bottom-0 behat-link-search" type="submit" value="Search">

            {% if filters.q %}
                <a href="{{ path('org_dashboard', {'status': filters.status}) }}" class="govuk-button govuk-button--secondary govuk-!-margin-bottom-0" role="button" data-module="govuk-button">
                    {{ 'clearSearch' | trans({}, 'common') }}
                </a>
            {% endif %}
        </div>
    </form>

    <table class="push--bottom">
        <thead>
            <tr>
                <th scope="col">{{ 'client' | trans({}, 'common') }}</th>
                {% if app.user.organisations | length > 1 %}
                    <th scope="col">{{ 'organisation' | trans({}, 'common') }}</th>
                {% endif %}
                <th scope="col">{{ 'caseNumber' | trans({}, 'common') }}</th>
                <th scope="col">{{ 'reportDueDate' | trans({}, 'common') }}</th>
                <th scope="col">{{ 'reportType' | trans({}, 'common') }}</th>
                <th scope="col" class="numeric">{{ 'reportStatus' | trans({}, 'common') }}</th>
            </tr>
        </thead>
        <tbody>
        {% for report in reports %}
            {% set transOptions = {
                '%overdueDays%': report.dueDateDiffDays|abs,
                '%dueDays%': report.dueDateDiffDays
            } %}
            {# condition for setting an appendum for reports that are identified as changes needed #}
            {% set clientRegionAppend = "" %}
            {% if report.status.status == 'readyToSubmit' and report.unSubmitDate is not empty and report.submitted == false %}
                {% set clientRegionAppend = "-changes-needed" %}
            {% endif %}

            {% set linkToReportOverviewPage = path('report_overview', { 'reportId': report.id }) %}

            <tr class="behat-region-client behat-region-client-{{ report.client.caseNumber | upper }}{{ clientRegionAppend }}">
                <td>
                    <a href="{{ linkToReportOverviewPage }}" class="behat-link-pa-report-open behat-link-pa-report-{{ report.getPeriod() | behat_namify }}-open">{{ report.client.lastName | title | striptags }}, {{ report.client.firstName | title | striptags }}</a>
                </td>
                {% if app.user.organisations | length > 1 %}
                    <td>
                        {{ report.client.organisation.name }}
                    </td>
                {% endif %}
                <td>
                    {{ report.client.caseNumber|upper }}
                </td>
                <td>
                    {% if report.dueDate is not null %}
                        <span>{{ report.dueDate | date("j M Y") }}</span><br>
                        {% if report.dueDateDiffDays < 0 %}
                            <span class="govuk-body-s govuk-!-font-weight-bold text-red">{{ 'overdue' | trans(transOptions) }}</span>
                        {% elseif report.dueDateDiffDays == 0 %}
                            <span class="govuk-body-s govuk-!-font-weight-bold">{{ 'dueToday' | trans }}</span>
                        {% elseif report.dueDateDiffDays <= 30 %}
                            <span class="govuk-body-s">{{ 'dueIn' | trans(transOptions) }}</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="width-fifth">
                    <span>{{ report.reportTypeDefinition }}</span>
                </td>
                <td class="numeric">
                    {% if report.status.status == 'notStarted' %}
                        <span class="govuk-tag govuk-tag--grey">{{ 'notStarted' | trans({}, 'common') }}</span>
                    {% elseif report.status.status == 'notFinished' %}
                        <span class="govuk-tag govuk-tag--yellow">{{ 'notFinished' | trans({}, 'common') }}</span>
                    {% elseif report.status.status == 'readyToSubmit' %}
                        {% if report.unSubmitDate is not empty and report.submitted == false %}
                            <span class="govuk-tag govuk-tag--red">{{ 'changesNeeded' | trans({}, 'common') }}</span>
                        {% else  %}
                            <span class="govuk-tag govuk-tag--green">{{ 'readyToSubmit' | trans({}, 'common') }}</span>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% if reports |length == 0 %}
        <p class="govuk-body">{{ 'sorryNoResultsFor' | trans({}, 'common') }}</p>
        <hr>
    {% endif %}

    {% include '@App/Components/paginator.html.twig' with {
        currentOffset: filters.offset,
        recordsPerPage: filters.limit,
        totalRecords: counts[filters.status ?: 'total'],
        routeName: 'org_dashboard',
        routeParams: {
            'status': filters.status,
            'q': filters.q
        },
        messages: {
            singlePage: {
                singular: 'Showing 1 client',
                plural: 'Showing %count% clients'
            },
            multiPage: 'Showing %from% - %to% of %total% clients'
        }
    } %}

{% endblock %}
