server {
    listen 80 default_server;
    server_name _;

    root /www/data/public;
    server_tokens off;


    # --- Security Headers ---
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Referrer-Policy "same-origin" always;
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https://*.google-analytics.com https://*.googletagmanager.com; connect-src 'self' https://*.google-analytics.com https://*.analytics.google.com https://*.googletagmanager.com; script-src 'self' https://*.google-analytics.com https://*.googletagmanager.com; style-src 'self';" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY;
    add_header Permissions-Policy "geolocation=()" always;

    client_max_body_size 0;
    client_body_timeout 240s;

    # Static fallback
    location ~* \.(css|jpg|png|ico|jpeg|woff2|woff|map)$ {
        expires 24h;
        access_log off;
        rewrite ^/assets/([0-9]+)/(.*) /assets/fallback/$2 break;
    }

    # Blackhole sensitive extensions
    location ~* \.(zip|gz|lzh|tar|rar|7z|swp|bak|git|ht|exe|dll|py|msi|bin|sh|bat|xml|apk|jar|log|sql|conf|cfg|ini|tmp|doc|xls|rtf|env|js)$ {
        location ~ (common|application|jquery\.min)\.js {
           expires    24h;
           access_log off;
           rewrite	^/assets/([0-9]+)/(.*) /assets/fallback/$2 break;
        }
        return 404;
    }

    # Front controller handling
    location / {
        try_files $uri /index.php$is_args$args;
    }

    error_log /var/log/nginx/error.log warn;

    # --- PHP HANDLER ---
    # This block handles index.php and routed PHP
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        include fastcgi.conf;

        # IMPORTANT: this path must match the PHP-FPM container, not Nginx
        fastcgi_param SCRIPT_FILENAME /var/www/public$fastcgi_script_name;

        fastcgi_param HTTP_X_AWS_REQUEST_ID $aws_request_id;
        fastcgi_hide_header X-Powered-By;
        fastcgi_hide_header X-Csp-Nonce;

        fastcgi_request_buffering off;
        fastcgi_read_timeout 300s;

        fastcgi_pass @php;
        internal;
    }


    # Block any other PHP file (not index.php)
    location ~ ^/(?!index\.php).+\.php$ {
        return 404;
    }


    # security.txt redirect
    rewrite ^/.well_known/security.txt$ https://raw.githubusercontent.com/ministryofjustice/security-guidance/master/contact/vulnerability-disclosure-security.txt permanent;
}

# CSP Response server
server {
    listen 8080 default_server;
    server_name _;

    location /_csp_response {
        access_log off;
        return 204;
    }
}

upstream @php {
    server ${APP_HOST}:${APP_PORT};
}
